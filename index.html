<!DOCTYPE html>
        <html lang="en">
          <head>
            <meta charset="utf-8">
            <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no' />
            <title>SWY</title>
            <!-- bar chart -->
            <link rel="stylesheet" href="css/autocomplete.css" />
            <link rel="stylesheet" href="css/timeline.css" />

            <!-- Leaflet -->
            <link rel="stylesheet" href="css/leaflet.css" />
            <link rel="stylesheet" href="css/leaflet-sidebar.css" />
            <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
            <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css">
            <link href="css/radio-input-group.css" rel="stylesheet">
            <link href="css/button.css" rel="stylesheet">
            <link href="https://fonts.googleapis.com/css?family=Fira+Sans" rel="stylesheet">

            <link href="css/bootstrap-tabs-x-bs4.css" media="all" rel="stylesheet" type="text/css" />

            <script src="lib/leaflet.js"></script>
            <script src="lib/leaflet.groupedlayercontrol.min.js"></script>
            <script src="src/colorMapLegend.js"></script>
            <script src="src/colorDefs.js"></script>
            <script src="lib/leaflet-heat.js"></script>
            <script src="lib/jquery-3.3.1.min.js"></script>
            <script src="js/canton_center.js"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"></script>
            <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js" type="text/javascript"></script>
            <script src="lib/bootstrap-tabs-x.min.js" type="text/javascript"></script>
        <style>
        body, table, tr, td, th, div, h1, h2, input { font-family: "Calibri", "Trebuchet MS", "Ubuntu", Serif; font-size: 11pt; }
        body, html {height:"100%"}
        #map { position:absolute; top:0; bottom:0; width:100%;} /* full size */
        .ctl {
            padding: 2px 10px 2px 10px;
            background: white;
            background: rgba(255,255,255,0.9);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
            text-align: right;
        }
        .title {
            font-size: 18pt;
            font-weight: bold;
        }
        .src {
            font-size: 10pt;
        }

        .split {
            float:left !important;
            height: 100% !important;
            width: 33.33% !important;
            border: 1px  dashed;
        }

        /* Control the left side */
        .left {
            left: 0;
            background-color: #111;
        }

        /* Control the right side */
        .right {
            right: 0;
            background-color: red;
        }

        </style>

        </head>
        <body>
          <script src='lib/topojson.min.js'></script>
          <script src="lib/d3.min.js"></script>
          <script src="lib/leaflet-sidebar.js"></script>

          <!-- Divide the screen into three parts-->
          <div id="ctl_panel_div" class="split" style="border: 2px solid black">
            <form class="form">
              <p style="font-size:20px">Control panel</p>
              <p style="font-size:18px">Choose data</p>
              <div class="inputGroup">
                <input id="radio1" name="myRadios" type="radio" value="0"/>
                <label for="radio1">Baseflow</label>
              </div>
              <div class="inputGroup">
                <input id="radio2" name="myRadios" type="radio" value="1"/>
                <label for="radio2">Quickflow</label>
              </div>
              <div class="inputGroup">
                <input id="radio3" name="myRadios" type="radio" value="null"/>
                <label for="radio3">No data</label>
              </div>
            </form>

            <form class="form">
              <p style="font-size:18px">Canton search</p>
              <div class="dropdown">
                <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownSearch" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                  Choose canton
                  <span class="caret"></span>
                </button>
                <ul style="height:auto;max-height:200px;overflow-x:hidden;" class="dropdown-menu" aria-labelledby="dropdownMenuButton" id="dropdownList">
                </ul>
                <button style="margin-left:20px" type="button" class="btn btn-outline-primary">Search</button>
              </div>

              <div class="autocomplete" style="margin-left:50px;">
                  <input id="myInput" type="text" name="myCountry" placeholder="State">
              </div>
              <button type="button" class="btn-success" onclick="getInput()">Search</button>

            </form>

            <form class="form">
              <div>
                <p style="font-size:18px">Timeline</p>
              </div>

              <div class="dropdown">
                <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownSearchTimeline" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                  Choose dataset
                  <span class="caret"></span>
                </button>
                <ul style="height:auto;max-height:200px;overflow-x:hidden;" class="dropdown-menu timeline" aria-labelledby="dropdownMenuButton" id="dropdownListTimeline">
                  <li><a class="dropdown-item" href="#" id="timeline-item1" name="timelineItems"> Historical </a></li>
                  <li><a class="dropdown-item" href="#" id="timeline-item2" name="timelineItems"> RCP:45 2020 25%</a></li>
                  <li><a class="dropdown-item" href="#" id="timeline-item3" name="timelineItems"> RCP:45 2020 25% allag</a></li>
                  <li><a class="dropdown-item" href="#" id="timeline-item4" name="timelineItems"> RCP:45 2040 25%</a></li>
                  <li><a class="dropdown-item" href="#" id="timeline-item5" name="timelineItems"> RCP:45 2040 25% allag</a></li>
                  <li><a class="dropdown-item" href="#" id="timeline-item6" name="timelineItems"> RCP:85 2020 75%</a></li>
                  <li><a class="dropdown-item" href="#" id="timeline-item7" name="timelineItems"> RCP:85 2040 75%</a></li>
                </ul>
              </div>

              <div>

              <span style="float:left"><div style="width:340px" id="vis" style="height:120px"></div></span>
              <span style="float:left"><button id="play-button" style="margin-top:25px;margin-left:10px">Play</button></span>
              <span style="float:left;width:40px">
                <img src="http://www.endlessicons.com/wp-content/uploads/2012/11/reset-icon-614x460.png" style="margin-top:17px;" id="reset" onclick = "Reset()" />
              </span>
              </div>
            </form>
          </div>
          <div id="stat_div" class="split" style="background-color:gray">
            <p style="font-size:20px">Statistics</p>

          </div>
          <div id="map" class="sidebar-map split" style="right:0 !important"></div>

        <script src='data/mapList.js'></script>
        <script src='js/d3v4.js'></script>
        <script src='js/autocomplete.js'></script>
        <script src='js/timeline.js'></script>
        <script src='js/fengyu.js'></script>
        <script src='js/search-cantons.js'></script>

        <script>

        // Load heatmap data
        $.getScript("data/qf_historical_12months/qf_historical_12months.js", function( data, textStatus, jqxhr ) {
          console.log("Load was performed.");
        });

        // Add cantons to dropdown list
        addElementsToList();

        // Remove the default behavior of a button
        $("#play-button").click( function(event) {
           event.preventDefault();
           console.log('clean the default');
        });

        setDropdownTimeline('Historical');
        setListenersDropdownTimeline();

        /* **** Leaflet **** */

        // Base layers
        //  .. OpenStreetMap
        d3.geoPath();
        var osm = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'});

        //  .. CartoDB Positron
        var cartodb = L.tileLayer('http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="http://cartodb.com/attributions">CartoDB</a>'});

        //  .. OSM Toner
        var toner = L.tileLayer('http://{s}.tile.stamen.com/toner/{z}/{x}/{y}.png', {attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="http://openstreetmap.org">OpenStreetMap</a>, under <a href="http://www.openstreetmap.org/copyright">ODbL</a>.'});

        //  .. White background
        var white = L.tileLayer("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEAAQMAAABmvDolAAAAA1BMVEX///+nxBvIAAAAH0lEQVQYGe3BAQ0AAADCIPunfg43YAAAAAAAAAAA5wIhAAAB9aK9BAAAAABJRU5ErkJggg==");

        // Overlay layers (TMS)
        // Add here the new layouts
        var lyr0 = L.tileLayer('data/B_historical_change/{z}/{x}/{y}.png', {tms: true, opacity: 0.8, attribution: ""});
        var lyr1 = L.tileLayer('data/B_flow_retention/{z}/{x}/{y}.png', {tms: true, opacity: 0.8, attribution: ""});

        // Map
        var map = L.map('map', {
            center: [19.2436590371, 96.8861699425],
            zoom: 5,
            minZoom: 5,
            maxZoom: 9,
            layers: [osm]
        });

        let bounds_map = map.getBounds();
        console.log(bounds_map._northEast.lat);

        bounds_map._northEast.lat += 5;
        bounds_map._northEast.lin+= 5;
        bounds_map._southWest.lat -= 5;
        bounds_map._southWest.lin -= 5;
        map.setMaxBounds(bounds_map);

        var basemaps = {"OpenStreetMap": osm, "CartoDB Positron": cartodb, "Stamen Toner": toner, "Without background": white};

        map.on('baselayerchange', function(e) {
          currentLayer.bringToFront();
        });

        // Title, 'ctl title'
        var title = L.control({position: 'bottomleft'});
        title.onAdd = function(map) {
	        this._div = L.DomUtil.create('div');
            let startPoint = {'lat': 19.2436590371, 'lin': 96.8861699425}
	        this.update(startPoint['lat'], startPoint['lin'], nearestPoint(startPoint), 'Mandalay');
	        return this._div;
        };
        title.update = function(lat, log, val, canton) {
            console.log(lat);
	        this._div.innerHTML = `<div class="leaflet-control-layers leaflet-control-layers-expanded" style="width:145px;height:90px;background:gray">
                <span>canton: ` + canton.toString() + `</span>
                <span>Longtitude: ` + log.toString().substr(0,5) + `</span>
                <span>Latitude:   ` + lat.toString().substr(0,5) + `<br /></span>
                <span>Value: ` + val.toString().substr(0,5) + ` </span>
             </div>`;
        };
        title.addTo(map);



         // Use the custom grouped layer control, not "L.control.layers"
        L.control.layers(basemaps, null).addTo(map);

        // Remove the stupid leaflet copyright from bottom right

        let stupid_element = document.querySelector('.leaflet-control-attribution.leaflet-control');
        stupid_element.parentNode.removeChild(stupid_element);

        // make the side bar close
        //sidebar.open('home');

        // Obtain the data for the statistics_div
        let stat_div_element = d3.select('#stat_div');
        console.log(stat_div_element);
        console.log('default width', stat_div_element.node().getBoundingClientRect().width);

        // Initialization of statistics plotting
        const margin = {
            top: 30,
            right: 30,
            bottom: 30,
            left: 50
        };
        const height_stat = 300;
        const height_brush = 30;
        const height_tick = 18;
        const panel_guide_height = 500;
        const height_total = height_stat + height_brush + height_tick + 100;
        const width = stat_div_element.node().getBoundingClientRect().width - margin.right - margin.left;
        const svg_y =  - height_total - margin.top - margin.bottom - panel_guide_height;
        const color = 'steelblue';

        // Build statistics svg
        stat_svg = d3.select('#stat_div')
                        .append('svg')
                        .attr('transform', 'translate(0,' + 0 + ')')
                        .attr('width', width + margin.left + margin.right)
                        .attr('height', height_total + margin.top + margin.bottom);

        // Build a background rect
        back_rect = stat_svg.append('rect')
                                .attr('width', width + margin.left + margin.right)
                                .attr('height', height_total + margin.top + margin.bottom)
                                .attr('fill', 'white')
                                .attr('opacity', 0.6);
    // Add statistics name
        stat_svg.append('text')
                .text('Histogram of Ouput Seasonal Water Yield')
                .attr('fill', 'black')
                .attr('font-size', 15)
                .attr('transform', 'translate(10, 120)');

        // Build statistics brush group
        let stat_brush_g = stat_svg.append('g')
                                    .attr('id', 'stat_brush_group')
                                    .attr('transform',
                                        'translate(' + margin.left + ',' + (margin.top + height_total - height_brush) + ')');

        // Build brush background rectangle
        let brush_rect = stat_brush_g.append('rect')
                                    .attr('id', 'brush_rect')
                                    .attr('width', width)
                                    .attr('height', height_brush)
                                    .attr('stroke-width', 1)
                                    .attr('stroke', 'red')
                                    .attr('fill', 'blue')
                                    .attr('fill-opacity', 0.1);

        // Add brush name
        stat_svg.append('text')
                    .text('Brush')
                    .attr('fill', 'black')
                    .attr('transform', 'translate(0,' + (height_total + margin.top - height_brush + 10) + ')')
                    .attr('font-size', 18);


        createD3LegendBox(stat_svg, 0);

        // Add province name group
        let prov_name_g = stat_svg.append('g')
                                    .attr('transform', 'translate(' + (margin.left + width - 20) + ',50)')
                                    .attr('width', 20 + margin.right);

        prov_name_g.append('text')
                        .text('Province')
                        .attr('dx', -50)
                        .attr('dy', -20)
                        .attr('text-anchor', 'middle')
                        .attr('font-size', 25);


        // Add canton border to the map
        let svg = d3.select(map.getPanes().overlayPane).append('svg').attr('id', 'svg');
        let g = svg.append('g').attr('class', 'leaflet-zoom-hide');

        // Map promise
        const map_promise = d3.json('map/MYANMAR_GEOJSON.json').then(x => x);

        // Define project point function
        function project_point(x, y){
            let point = map.latLngToLayerPoint(new L.LatLng(y, x));
            this.stream.point(point.x, point.y);
        }

        let canton = null;

        let stat = d3.json("./data/stat.json").then(d => d);

        // load statistics json
        const full_stat = d3.json('./data/prov_data.json').then(d => d);

        let transform = d3.geoTransform({point: project_point});
        let gen_path = d3.geoPath().projection(transform);


        Promise.all([map_promise, full_stat]).then((results) => {
            let feature = g.selectAll('path')
                            .data(results[0].features)
                            .enter()
                                .append('path')
            feature.attr('d', gen_path)
                    .attr('class', 'province')
                    .attr('fill-opacity', 0)
                    .attr('position', 'relative')
                    .attr('stroke', 'green')
                    .attr('stroke-width', 2)
                    .attr('stroke-opacity', 0.5)
                    .on('mousedown.log', (d) => {

                        // Set the canton
                        canton = d.properties['NAME_1'];
                        console.log(d.properties['NAME_1']);

                        // Draw the statistics of canton

                        // Get statistics

                        stat_results = results[1];
                        console.log(stat_results);
                        let bins = stat_results['bins'][canton];
                        let bin_size = bins[1] - bins[0];
                        let counts = stat_results['full_disc_data_counts'][canton];

                        let max_count = Math.max.apply(Math, counts);


                        // For better user experience we first zoom in to dense part
                        let init_index = bins.length / 2 - 20;
                        let init_length = 40;
                        let init_max_count = Math.max.apply(Math, counts.slice(init_index, init_index + init_length));
                        // construct x y and color scale
                        let y_scale = d3.scaleLinear()
                                                .domain([0, init_max_count])
                                                .range([height_stat, 0]);

                        let x_scale = d3.scaleLinear()
                                                .domain([0, init_length])
                                                .range([0, width]);

                        let color_scale = d3.scaleLinear()
                                                .domain([0, max_count])
                                                .range([d3.rgb(color).brighter(),
                                                        d3.rgb(color).darker()]);
                        // Plot the bar chart

                        // Remove old info
                        stat_svg.select('.stat_group')
                                    .remove();
                        prov_name_g.select('#prov_name')
                                    .remove()
                        stat_svg.select('#stat_brush_group')
                                    .remove();
                        // Plot new info
                        prov_name_g.append('text')
                                    .text(canton)
                                    .attr('font-size', 20)
                                    .attr('color', 'black')
                                    .attr('text-anchor', 'end')
                                    .attr('id', 'prov_name');

                        // Build statistics group
                        let stat_g = stat_svg.append('g')
                                        .attr('class', 'stat_group')
                                        .attr('id', '#stat_group')
                                        .attr('transform',
                                            'translate(' + margin.left + ',' + (margin.top + height_total - height_stat - height_tick - height_brush) + ')');

                        // Build statistics plot group
                        let stat_plot_g = stat_g.append('g')
                                                    .attr('id', 'stat_plot_group');

                        // Rebuild statistics brush group
                        let stat_brush_g = stat_svg.append('g')
                                                    .attr('id', 'stat_brush_group')
                                                    .attr('transform',
                                                        'translate(' + margin.left + ',' + (margin.top + height_total - height_brush) + ')');

                        // Rebuild brush background rectangle
                        let brush_rect = stat_brush_g.append('rect')
                                                    .attr('id', 'brush_rect')
                                                    .attr('width', width)
                                                    .attr('height', height_brush)
                                                    .attr('stroke-width', 1)
                                                    .attr('stroke', 'red')
                                                    .attr('fill', 'blue')
                                                    .attr('fill-opacity', 0.1);

                        // Plot rectangles
                        let bar_width = width / init_length;


                        let bars = stat_plot_g.selectAll('g')
                                .data(counts.slice(init_index, init_index + init_length))
                                .enter()
                                    .append('g')
                                    .attr('transform',
                                        (d, i) => 'translate(' +
                                         x_scale(i) + ',' + 0 + ')');

                        bars.append('rect')
                                .attr('y', (d, i) => y_scale(d))
                                .attr('height', (d, i) =>
                                    height_stat - y_scale(d))
                                .attr('width', bar_width)
                                .attr('fill', (d) => color_scale(d));
                        console.log(bins.length);

                        // Add axis to the bar chart
                        let x_axis_scale = d3.scaleLinear()
                                                    .domain([bins[init_index], bins[init_index + init_length]])
                                                    .range([0, width]);

                        let x_axis = d3.axisBottom()
                                            .scale(x_axis_scale);

                        let x_axis_g = stat_g.append('g')
                                        .attr('transform', 'translate(0,' + height_stat + ')')
                                        .call(x_axis);

                        // Add x_axis to brush
                        let brush_scale = d3.scaleLinear()
                                                .domain([bins[0], bins[bins.length - 1]])
                                                .range(x_axis_scale.range());

                        let brush_axis = d3.axisBottom()
                                            .scale(brush_scale);

                        let brush_axis_g = stat_g.append('g')
                                                    .attr('id', 'brush_axis_g')
                                                    .attr('transform', 'translate(0,' + (height_stat + 18 + height_brush) + ')')
                                                    .call(brush_axis);

                        // Add outlier indication
                        brush_axis_g.append('g')
                                        .attr('text', '>' + max_count)
                                        .attr('transform', 'translate(' + width + ',' + (height_stat + height_brush + 25) + ')')
                                        .attr('font-size', 25)
                                        .attr('fill', 'black');

                        // Add y_axis
                        let y_axis = d3.axisLeft()
                                            .scale(y_scale);
                        let y_axis_g = stat_g.append('g')
                                            .attr('id', 'y_axis_g')
                                            .call(y_axis);

                        // Add color bar
                        /*
                        let color_bar = d3.select('body').append('canvas')
                                                  .attr('width', 200)
                                                  .attr('height', 50)
                                                  .attr('id', 'hello');
                        let color_bar_ctx = color_bar.getContext('2d');
                        for (let i = 0; i < 255; i++){
                            color_bar_ctx.beginPath();
                            let color = 'rgb(100, ' + i + ',' + i + ')';

                            color_bar_ctx.fillStyle = color;

                            color_bar_ctx.fillRect(i * 2, 0, 2, 50);
                        }
                        */
                        let stat_brushX = d3.brushX()
                                            .extent([[0, 0],
                                                [width, height_brush]])
                                            .on('end', function() {

                                                if (!d3.event.sourceEvent)
                                                    return;

                                                L.DomEvent.stopPropagation(d3.event);
                                                console.log(d3.event.selection);

                                                let sel_result = d3.event.selection;
                                                let new_domain;
                                                let new_index;
                                                if (sel_result === null){
                                                    // define restoration to base case event
                                                    new_domain = [bins[0], bins[bins.length - 1]];
                                                    new_index = new_domain.map(x => x / bin_size + counts.length / 2);
                                                }
                                                else{
                                                    // define rescale event
                                                    new_domain = sel_result.map(brush_scale.invert);
                                                    // convert new domain to interger
                                                    new_domain = new_domain.map(x => Math.floor(x / bin_size) * bin_size);
                                                    // get new index
                                                    new_index = new_domain.map(x => x / bin_size + counts.length / 2);
                                                    new_index[1] -= 1;
                                                    console.log(new_domain);
                                                    console.log(new_index);
                                                }

                                                // Set up new x-scale and x-axis-scale
                                                // That is because x are indices while axis are real numbers
                                                x_axis_scale.domain(new_domain)
                                                            .ticks(new_index[1] - new_index[0] + 1);
                                                x_scale.domain([0, new_index[1] - new_index[0] + 1]);

                                                console.log("x_scale dom", x_scale.domain());
                                                // Set up new x-axis
                                                x_axis.scale(x_axis_scale);
                                                x_axis_g.call(x_axis);

                                                // Set up new y scale
                                                max_count = d3.max(counts.slice(new_index[0], new_index[1]));
                                                console.log(max_count);
                                                y_scale.domain([0, max_count]);
                                                y_axis.scale(y_scale);
                                                y_axis_g.call(y_axis);

                                                // Create new bar width
                                                bar_width = width / (new_index[1] - new_index[0] + 1);

                                                // Clear old rectangles
                                                stat_plot_g.selectAll('g')
                                                            .data([])
                                                            .exit()
                                                            .remove();

                                                // Add new rectangles
                                                stat_plot_g.selectAll('g')
                                                            .data(counts.slice(new_index[0],
                                                                        new_index[1]))
                                                            .enter()
                                                                .append('g')
                                                                .attr('transform', (d, i) => 'translate(' + x_scale(i) + ',0)');
                                                console.log(counts.slice(new_index[0], new_index[1]).length);
                                                console.log(new_domain[1] - new_domain[0]);

                                                stat_plot_g.selectAll('g')
                                                    .append('rect')
                                                    .attr('y', (d) => y_scale(d))
                                                    .attr('width', bar_width )
                                                    .attr('height', (d) => height_stat - y_scale(d))
                                                    .attr('fill', (d) => color_scale(d));


                                                // Restore map functions
                                                map.dragging.enable();
                                                map.touchZoom.enable();
                                                map.doubleClickZoom.enable();
                                                map.scrollWheelZoom.enable();
                                                map.boxZoom.enable();
                                                map.keyboard.enable();
                                                if (map.tap) map.tap.enable();
                                                document.getElementById('map').style.cursor='grab';

                                            });

                        // Prevent map from moving while we are focused on brushing

                        stat_brushX.on('brush', function(){
                                                    // Keep the map static
                                                    map.dragging.disable();
                                                    map.touchZoom.disable();
                                                    map.doubleClickZoom.disable();
                                                    map.scrollWheelZoom.disable();
                                                    map.boxZoom.disable();
                                                    map.keyboard.disable();
                                                    if (map.tap) map.tap.disable();
                                                    document.getElementById('map').style.cursor='default';
                                                });

                        stat_brush_g.call(stat_brushX);

                    });

            feature.on('mouseover', function(d, i){
                d3.selectAll('.province')
                    .style('fill-opacity', 0);
                d3.select(this).style('fill-opacity', 0.1);
            });

            feature.on('mouseout', function(d, i){
                d3.selectAll('.province')
                    .style('fill-opacity', 0);
                d3.select(this).style('fill-opacity', 0.0);
            });

            let bounds = gen_path.bounds(results[0]);
            let top_left = bounds[0];
            let bottom_right = bounds[1];

            svg.attr('width', bottom_right[0] - top_left[0])
                .attr('height', bottom_right[1] - top_left[1])
                .style('left', top_left[0] + 'px')
                .style('top', top_left[1] + 'px');

            g.attr('transform', 'translate(' + -top_left[0] + ',' + -top_left[1] + ')');


            map.on('moveend', () => {
                bounds = gen_path.bounds(results[0]);
                top_left = bounds[0];
                bottom_right = bounds[1];
                svg.attr('width', bottom_right[0] - top_left[0])
                    .attr('height', bottom_right[1] - top_left[1])
                    .style('left', top_left[0] + 'px')
                    .style('top', top_left[1] + 'px');

                g.attr('transform', 'translate(' + -top_left[0] + ',' + -top_left[1] + ')');
                feature.attr('d', gen_path);
            });

        });


	      var popup = L.popup();
        // Response to the mouse click
        map.on('click', function(e) {

            var data = {'lat': e.latlng.lat, 'lin': e.latlng.lng};

            let nearestP = nearestPoint(data);

            // do something with response
            if (canton != null){
                // popup.setLatLng(e.latlng)
                // .setContent("Position " + e.latlng.toString() + '\nCanton is ' + canton.toString() + '\nValue is ' + nearestP.toString())
                // .openOn(map)
                console.log(canton)
                title.update(data['lat'], data['lin'], nearestP, canton);
                //title.addTo(map);


                canton = null
            }
            // else {
            //     popup.setLatLng(e.latlng)
            //     .setContent("Position " + e.latlng.toString() + '\nValue is ' + nearestP.toString())
            //     .openOn(map)
            // }

        });

        // Declare radiobuttons listeners
        let radioButtons = document.getElementsByName("myRadios");
        radioButtons[0].checked = true;
        let prev = {
          value: "0"
        };
        map.addLayer(lyr0);
        let currentLayer = eval("lyr" + prev.value);

        for(var i = 0; i < radioButtons.length; i++) {
          radioButtons[i].addEventListener('change', function() {
            if(this.value !== "null") {
              if(currentLayer !== undefined) {
                map.removeLayer(eval("lyr" + prev.value));
              };

              prev = this;
              currentLayer = eval("lyr" + this.value);
              map.addLayer(currentLayer);
              currentLayer.bringToFront();
              createD3LegendBox(stat_svg, parseInt(this.value, 10));
            }
            
            if(this.value === "null") {
              map.removeLayer(currentLayer);
              currentLayer = undefined;
              removeColorBar();
            }
          });
        }

        // Fit to overlay bounds (SW and NE points with (lat, lon))
        // map.fitBounds([[9.92035336588, 101.633885799], [28.5669647084, 92.1384540862]]);

        </script>

        </body>
        </html>
